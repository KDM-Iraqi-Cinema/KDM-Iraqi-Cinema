<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø¥Ø¯Ø§Ø±Ø© Ù…ÙØ§ØªÙŠØ­ KDM - Ø§Ù„Ø³ÙŠÙ†Ù…Ø§ Ø§Ù„Ø±Ù‚Ù…ÙŠØ©</title>
<style>
  /* ØªØµÙ…ÙŠÙ… Ø¯Ø§ÙƒÙ† */
  body {
    background-color: #121212;
    color: #ddd;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 20px;
  }
  h1 {
    text-align: center;
    color: #f0c14b;
    margin-bottom: 30px;
    user-select: none;
  }
  form {
    background-color: #222;
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 25px;
    box-shadow: 0 0 10px #5a4b1c;
  }
  label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
    color: #f0c14b;
  }
  input[type="text"], input[type="datetime-local"] {
    width: 100%;
    padding: 10px 12px;
    margin-bottom: 15px;
    border: 1px solid #555;
    border-radius: 5px;
    background-color: #1f1f1f;
    color: #eee;
    font-size: 1rem;
    box-sizing: border-box;
    transition: border-color 0.3s;
  }
  input[type="text"]::placeholder,
  input[type="datetime-local"]::placeholder {
    color: #999;
  }
  input[type="text"]:focus, input[type="datetime-local"]:focus {
    outline: none;
    border-color: #f0c14b;
    background-color: #2c2c2c;
  }
  button {
    background-color: #bfae48; /* Ø°Ù‡Ø¨ÙŠ Ù‚Ø±ÙŠØ¨ */
    color: #222;
    font-weight: bold;
    border: none;
    border-radius: 6px;
    padding: 12px 25px;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.3s ease;
    user-select: none;
  }
  button:hover {
    background-color: #d4c36e;
  }
  .kdm-list {
    max-width: 900px;
    margin: auto;
    border-collapse: collapse;
    width: 100%;
  }
  .kdm-list th, .kdm-list td {
    padding: 12px 15px;
    border-bottom: 1px solid #333;
    text-align: center;
    vertical-align: middle;
  }
  .kdm-list th {
    background-color: #2e2e2e;
    color: #f0c14b;
  }
  .kdm-row {
    background-color: #1e1e1e;
    transition: background-color 0.3s ease;
  }
  /* Ù„ÙˆÙ† Ø£Ø­Ù…Ø± ÙƒØ§Ù…Ù„ Ù‚Ø¨Ù„ 5 Ø£ÙŠØ§Ù… Ù…Ù† Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ */
  .kdm-row.ending-soon {
    background-color: #a83232 !important;
    color: #fff;
  }
  .action-btn {
    margin: 0 5px;
    padding: 6px 14px;
    font-weight: bold;
    border-radius: 5px;
    border: none;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s;
  }
  .edit-btn {
    background-color: #bfae48;
    color: #222;
  }
  .edit-btn:hover {
    background-color: #d4c36e;
  }
  .delete-btn {
    background-color: #c43e3e;
    color: white;
  }
  .delete-btn:hover {
    background-color: #f04e4e;
  }
  /* ØªÙˆØ¶ÙŠØ­ Ø§Ù„Ø­Ù‚ÙˆÙ„ */
  .desc-text {
    color: #aaa;
    font-size: 0.9rem;
    margin-bottom: 10px;
    user-select: none;
  }
  @media (max-width: 600px) {
    .kdm-list th, .kdm-list td {
      font-size: 0.9rem;
      padding: 8px 10px;
    }
    button, .action-btn {
      padding: 8px 16px;
      font-size: 0.9rem;
    }
  }
</style>
</head>
<body>

<h1>Ø¥Ø¯Ø§Ø±Ø© Ù…ÙØ§ØªÙŠØ­ KDM - Ø§Ù„Ø³ÙŠÙ†Ù…Ø§ Ø§Ù„Ø±Ù‚Ù…ÙŠØ©</h1>

<form id="kdmForm">
  <label for="movieName">Ø§Ø³Ù… Ø§Ù„ÙÙŠÙ„Ù…:</label>
  <input type="text" id="movieName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ÙÙŠÙ„Ù…" required />

  <div class="desc-text">Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø¨Ø¯Ø¡ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙØªØ§Ø­ (KDM):</div>
  <input type="datetime-local" id="startTime" required placeholder="ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©" />

  <div class="desc-text">Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ù†Ù‡Ø§ÙŠØ© ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙØªØ§Ø­ (KDM):</div>
  <input type="datetime-local" id="endTime" required placeholder="ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡" />

  <button type="submit">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙØªØ§Ø­</button>
</form>

<table class="kdm-list" id="kdmTable" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ù…ÙØ§ØªÙŠØ­ KDM">
  <thead>
    <tr>
      <th>Ø§Ø³Ù… Ø§Ù„ÙÙŠÙ„Ù…</th>
      <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
      <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
      <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
    </tr>
  </thead>
  <tbody id="kdmBody">
    <!-- Ù…ÙØ§ØªÙŠØ­ KDM Ø³ØªØ¶Ø§Ù Ù‡Ù†Ø§ -->
  </tbody>
</table>

<script>
  const apiUrl = 'https://kdm-iraqi-cinema.onrender.com/kdms';

  const kdmForm = document.getElementById('kdmForm');
  const kdmBody = document.getElementById('kdmBody');

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ÙˆØ¹Ø±Ø¶Ù‡Ø§
  async function loadKDMs() {
    kdmBody.innerHTML = '';
    try {
      const res = await fetch(apiUrl);
      if (!res.ok) throw new Error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
      const kdms = await res.json();

      if (kdms.length === 0) {
        kdmBody.innerHTML = `<tr><td colspan="4" style="color:#aaa;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙØ§ØªÙŠØ­ KDM Ù…Ø³Ø¬Ù„Ø©</td></tr>`;
        return;
      }

      const now = new Date();
      kdms.forEach(({ _id, movieName, startTime, endTime }) => {
        const start = new Date(startTime);
        const end = new Date(endTime);
        const diffDays = Math.ceil((end - now) / (1000 * 60 * 60 * 24));
        const isEndingSoon = diffDays <= 5 && diffDays >= 0;

        const row = document.createElement('tr');
        row.className = 'kdm-row' + (isEndingSoon ? ' ending-soon' : '');

        row.innerHTML = `
          <td>${movieName}</td>
          <td>${start.toLocaleString('ar-EG')}</td>
          <td>${end.toLocaleString('ar-EG')}</td>
          <td>
            <button class="action-btn edit-btn" onclick="editKDM('${_id}', '${escapeHTML(movieName)}', '${startTime}', '${endTime}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="action-btn delete-btn" onclick="deleteKDM('${_id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </td>
        `;
        kdmBody.appendChild(row);
      });
    } catch (error) {
      alert(error.message);
    }
  }

  // Ø§Ù„Ù‡Ø±ÙˆØ¨ Ù…Ù† Ø£Ø­Ø±Ù HTML Ø§Ù„Ø®Ø§ØµØ©
  function escapeHTML(text) {
    return text.replace(/[&<>"']/g, function(m) {
      return ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[m];
    });
  }

  // Ø¥Ø¶Ø§ÙØ© Ù…ÙØªØ§Ø­ Ø¬Ø¯ÙŠØ¯
  kdmForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const movieName = document.getElementById('movieName').value.trim();
    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;

    if (!movieName || !startTime || !endTime) {
      alert('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.');
      return;
    }

    try {
      const res = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ movieName, startTime, endTime })
      });
      if (!res.ok) throw new Error('ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙØªØ§Ø­.');
      kdmForm.reset();
      await loadKDMs();
    } catch (error) {
      alert(error.message);
    }
  });

  // Ø­Ø°Ù Ù…ÙØªØ§Ø­
  async function deleteKDM(id) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙØªØ§Ø­ØŸ')) return;
    try {
      const res = await fetch(`${apiUrl}/${id}`, { method: 'DELETE' });
      if (!res.ok) throw new Error('ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…ÙØªØ§Ø­.');
      await loadKDMs();
    } catch (error) {
      alert(error.message);
    }
  }

  // ØªØ¹Ø¯ÙŠÙ„ Ù…ÙØªØ§Ø­
  function editKDM(id, movieName, startTime, endTime) {
    document.getElementById('movieName').value = movieName;
    document.getElementById('startTime').value = startTime;
    document.getElementById('endTime').value = endTime;

    const button = kdmForm.querySelector('button');
    button.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';

    // Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« submit Ù…ÙˆØ¬ÙˆØ¯ Ø³Ø§Ø¨Ù‚Ø§Ù‹ Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    const newForm = kdmForm.cloneNode(true);
    kdmForm.parentNode.replaceChild(newForm, kdmForm);

    newForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const updatedName = document.getElementById('movieName').value.trim();
      const updatedStart = document.getElementById('startTime').value;
      const updatedEnd = document.getElementById('endTime').value;

      if (!updatedName || !updatedStart || !updatedEnd) {
        alert('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.');
        return;
      }

      try {
        const res = await fetch(`${apiUrl}/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            movieName: updatedName,
            startTime: updatedStart,
            endTime: updatedEnd
          }),
        });

        if (!res.ok) throw new Error(`ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« - ${res.statusText}`);
        newForm.reset();
        button.textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙØªØ§Ø­';
        await loadKDMs();
      } catch (err) {
        alert(`Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ${err.message}`);
      }
    });
  }

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
  loadKDMs();
</script>

</body>
</html>
