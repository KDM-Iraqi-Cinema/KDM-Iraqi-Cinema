<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>إدارة KDM</title>
<style>
  body {
    background-color: #121212;
    color: #f0f0f0;
    font-family: Arial, sans-serif;
    margin: 0; padding: 0;
  }
  .container {
    max-width: 800px;
    margin: auto;
    padding: 20px;
  }
  input, button {
    padding: 8px;
    margin: 5px 0;
    width: 100%;
    border-radius: 4px;
    border: none;
  }
  button {
    background-color: #1f80e0;
    color: white;
    cursor: pointer;
  }
  button:hover {
    background-color: #1662b0;
  }
  .kdm-item {
    background-color: #222;
    margin: 10px 0;
    padding: 10px;
    border-radius: 6px;
  }
  .hidden {
    display: none;
  }
  .error, .success {
    margin: 10px 0;
    padding: 10px;
    border-radius: 4px;
  }
  .error {
    background-color: #e74c3c;
    color: white;
  }
  .success {
    background-color: #2ecc71;
    color: white;
  }
</style>
</head>
<body>
<div class="container">

  <h1>تسجيل الدخول / إنشاء حساب</h1>

  <div id="auth-section">
    <input type="text" id="username" placeholder="اسم المستخدم" />
    <input type="password" id="password" placeholder="كلمة المرور" />
    <button id="btn-login">تسجيل الدخول</button>
    <button id="btn-signup">إنشاء حساب جديد</button>
    <div id="auth-message"></div>
  </div>

  <div id="main-section" class="hidden">
    <button id="btn-logout">تسجيل الخروج</button>
    <h2>إضافة KDM جديد</h2>
    <input type="text" id="movieName" placeholder="اسم الفيلم" />
    <input type="date" id="startDate" />
    <input type="date" id="endDate" />
    <button id="btn-add-kdm">إضافة</button>
    <div id="kdm-message"></div>

    <h2>قائمة الـ KDM</h2>
    <div id="kdms-list"></div>
  </div>

</div>

<script>
  const authSection = document.getElementById("auth-section");
  const mainSection = document.getElementById("main-section");
  const authMessage = document.getElementById("auth-message");
  const kdmMessage = document.getElementById("kdm-message");
  const kdmsList = document.getElementById("kdms-list");

  let loggedIn = false;

  function showMessage(element, message, isError = false) {
    element.textContent = message;
    element.className = isError ? "error" : "success";
    setTimeout(() => {
      element.textContent = "";
      element.className = "";
    }, 4000);
  }

  async function login() {
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value.trim();
    if (!username || !password) {
      showMessage(authMessage, "الرجاء إدخال اسم مستخدم وكلمة مرور", true);
      return;
    }
    try {
      const res = await fetch("/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });
      const data = await res.json();
      if (res.ok) {
        loggedIn = true;
        authSection.classList.add("hidden");
        mainSection.classList.remove("hidden");
        loadKdms();
        showMessage(authMessage, data.message);
      } else {
        showMessage(authMessage, data.message || "خطأ في تسجيل الدخول", true);
      }
    } catch {
      showMessage(authMessage, "فشل في الاتصال بالسيرفر", true);
    }
  }

  async function signup() {
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value.trim();
    if (!username || !password) {
      showMessage(authMessage, "الرجاء إدخال اسم مستخدم وكلمة مرور", true);
      return;
    }
    try {
      const res = await fetch("/signup", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });
      const data = await res.json();
      if (res.ok) {
        showMessage(authMessage, data.message);
      } else {
        showMessage(authMessage, data.message || "خطأ في إنشاء الحساب", true);
      }
    } catch {
      showMessage(authMessage, "فشل في الاتصال بالسيرفر", true);
    }
  }

  async function loadKdms() {
    try {
      const res = await fetch("/get-kdms");
      const kdms = await res.json();
      if (!Array.isArray(kdms)) {
        showMessage(kdmMessage, "خطأ في تحميل بيانات الـ KDM", true);
        return;
      }
      kdmsList.innerHTML = "";
      kdms.forEach(kdm => {
        const div = document.createElement("div");
        div.className = "kdm-item";
        div.innerHTML = `
          <strong>${kdm.movieName}</strong><br/>
          من: ${new Date(kdm.startDate).toLocaleDateString()} إلى: ${new Date(kdm.endDate).toLocaleDateString()}<br/>
          <button onclick="editKdm('${kdm._id}')">تعديل</button>
          <button onclick="deleteKdm('${kdm._id}')">حذف</button>
        `;
        kdmsList.appendChild(div);
      });
    } catch {
      showMessage(kdmMessage, "فشل في جلب بيانات الـ KDM", true);
    }
  }

  async function addKdm() {
    const movieName = document.getElementById("movieName").value.trim();
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;
    if (!movieName || !startDate || !endDate) {
      showMessage(kdmMessage, "الرجاء تعبئة جميع الحقول", true);
      return;
    }
    try {
      const res = await fetch("/add-kdm", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ movieName, startDate, endDate })
      });
      const data = await res.json();
      if (res.ok) {
        showMessage(kdmMessage, data.message);
        loadKdms();
      } else {
        showMessage(kdmMessage, data.message || "خطأ في إضافة الـ KDM", true);
      }
    } catch {
      showMessage(kdmMessage, "فشل في الاتصال بالسيرفر", true);
    }
  }

  async function editKdm(id) {
    const newMovieName = prompt("أدخل اسم الفيلم الجديد:");
    if (!newMovieName) return;
    const newStartDate = prompt("أدخل تاريخ البداية الجديد (YYYY-MM-DD):");
    if (!newStartDate) return;
    const newEndDate = prompt("أدخل تاريخ النهاية الجديد (YYYY-MM-DD):");
    if (!newEndDate) return;

    try {
      const res = await fetch(`/edit-kdm/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ movieName: newMovieName, startDate: newStartDate, endDate: newEndDate })
      });
      const data = await res.json();
      if (res.ok) {
        showMessage(kdmMessage, data.message);
        loadKdms();
      } else {
        showMessage(kdmMessage, data.message || "خطأ في التعديل", true);
      }
    } catch {
      showMessage(kdmMessage, "فشل في الاتصال بالسيرفر", true);
    }
  }

  async function deleteKdm(id) {
    if (!confirm("هل أنت متأكد أنك تريد حذف هذا الـ KDM؟")) return;
    try {
      const res = await fetch(`/delete-kdm/${id}`, { method: "DELETE" });
      const data = await res.json();
      if (res.ok) {
        showMessage(kdmMessage, data.message);
        loadKdms();
      } else {
        showMessage(kdmMessage, data.message || "خطأ في الحذف", true);
      }
    } catch {
      showMessage(kdmMessage, "فشل في الاتصال بالسيرفر", true);
    }
  }

  document.getElementById("btn-login").onclick = login;
  document.getElementById("btn-signup").onclick = signup;
  document.getElementById("btn-add-kdm").onclick = addKdm;
  document.getElementById("btn-logout").onclick = () => {
    loggedIn = false;
    authSection.classList.remove("hidden");
    mainSection.classList.add("hidden");
  };
</script>
</body>
</html>
